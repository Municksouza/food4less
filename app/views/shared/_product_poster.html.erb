<div class="container py-5">
  <div class="row align-items-center mb-4">
    <div class="col-md-6">
      <h6 class="text-muted mb-1">Fresh Finds</h6>
      <h2 class="fw-bold mb-0">Explore Top Deals from Local Restaurants</h2>
    </div>
    <div class="col-md-6 text-md-end mt-3 mt-md-0">
      <div class="search-bar">
        <form class="search-pill" action="/search" method="get" accept-charset="UTF-8">
          <input type="text" name="query" placeholder="Search..." class="form-control" />
          <button type="submit" class="btn btn-outline-secondary">
            <i class="bi bi-search"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="product-list-scrollable mt-4">
    <div class="row g-3">
      <% @products.each do |product| %>
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="product-poster product-poster--horizontal">
            <!-- Image + Badge + Favorite -->
            <div class="poster-image-wrapper position-relative">
             
              <% if product.images&.attached? && product.images.any? %>
                <%= image_tag url_for(product.images.first), alt: product.name, class: "poster-image img-fluid" %>
              <% else %>
                <%= image_tag "placeholder.jpeg", alt: product.name, class: "poster-image img-fluid" %>
              <% end %>
                  
              <% if product.old_price.present? && product.old_price > product.price %>
                <% discount = ((1 - product.price.to_f / product.old_price.to_f) * 100).round %>
                <div class="poster-badge position-absolute top-0 start-0">âš¡ -<%= discount %>%</div>
              <% end %>

              <button class="poster-fav position-absolute top-0 end-0" type="button">
                <i class="far fa-heart"></i>
              </button>
            </div>

            <!-- Information -->
            <div class="poster-info mt-3">
              <% if product.store.present? %>
                <div class="poster-store-info d-flex align-items-center">
                  <% if product.store&.logo&.attached? %>
                    <%= image_tag url_for(product.store.logo),
                                  class: "store-logo me-2",
                                  alt: product.store.name %>
                  <% end %>
                  <div class="store-text">
                    <h6 class="store-name mb-0"><%= product.store.name %></h6>
                    <% if product.store.phone.present? %>
                      <p class="store-phone mb-0">
                        <i class="fas fa-phone-alt"></i>
                        <%= link_to product.store.phone, "tel:#{product.store.phone}", class: "phone-link" %>
                      </p>
                    <% end %>
                    <% if product.store.address.present? %>
                      <p class="store-address mb-0">
                        <i class="fas fa-map-marker-alt"></i>
                        <%= link_to product.store.address,
                                    "https://maps.google.com?q=#{URI.encode_www_form_component(product.store.address)}",
                                    target: "_blank", rel: "noopener" %>
                      </p>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <h5 class="poster-name mt-3"><%= product.name %></h5>
              <% if product.description.present? %>
                <p class="poster-desc"><%= truncate(product.description, length: 60) %></p>
                <% if product.stock.present? && product.stock > 0 %>
                  <p class="product-stock text-success small mt-1">
                    <i class="fas fa-box"></i> <%= product.stock %> in stock
                  </p>
                <% else %>
                  <span class="product-stock badge bg-danger mt-1">
                    <i class="fas fa-box-open"></i> Out of Stock
                  </span>
                <% end %>
              <% end %>

              <div class="poster-prices mt-2">
                <span class="current"><%= number_to_currency(product.price) %></span>
                <% if product.old_price.present? && product.old_price > product.price %>
                  <span class="old text-muted"><%= number_to_currency(product.old_price) %></span>
                <% end %>
              </div>
              <div class="disclaimer small text-muted text-center mt-2">
                <i class="fas fa-info-circle"></i>
                <span
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="Food4Less is just a facilitator; order accuracy and quality are the storeâ€™s responsibility."
                >
                  Terms ðŸ“„
                </span>
              </div>

              <div class="poster-ratings mt-2">
                <% avg = (product.reviews&.average(:rating)&.round rescue 0) || 0 %>
                <% count = product.reviews&.count || 0 %>
                <div class="poster-rating d-flex justify-content-center">
                  <% 5.times do |i| %>
                    <i class="<%= i < avg ? 'fas' : 'far' %> fa-star text-warning"></i>
                  <% end %>
                  <span class="ms-2 text-muted">(<%= count %>)</span>
                </div>
              </div>

              <%= link_to add_item_customers_cart_path(product), method: :post, class: "poster-cart-btn btn btn-primary mt-3" do %>
                <i class="fas fa-shopping-basket"></i> 
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>