<h1 class="mb-4">Your Shopping Cart</h1>
<%= link_to "← Back", (session[:previous_url] || root_path), class: "btn btn-outline-secondary mb-3" %>

<% if @cart.present? && @cart.any? %>
  <% @cart.each do |store_id, items| %>
    <% store = Store.find_by(id: store_id) %>
    <% next unless store %>

    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><%= store.name %></h5>
        <small><%= store.address %> | <%= store.phone %></small>
      </div>

      <div class="card-body">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Subtotal</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% total = 0 %>
            <% items.each do |product_id, item_quantity| %>
              <% product = Product.find_by(id: product_id) %>
              <% next unless product %>
              <% subtotal = product.price * item_quantity %>
              <% total += subtotal %>
              <tr>
                <td><%= product.name %></td>
                <td>
                <%= form_with url: update_item_customers_cart_path(product_id: product.id), method: :patch, local: true, class: "d-inline-flex gap-2 align-items-center" do |f| %>
                  <%= f.number_field :quantity, value: item_quantity, min: 1, class: "form-control w-75" %>
                  <%= f.submit "Update", class: "btn btn-sm btn-warning ms-2" %>
                <% end %>
                </td>
                <td><%= number_to_currency(product.price) %></td>
                <td><%= number_to_currency(subtotal) %></td>
                <td>
                  <%= button_to "Remove", remove_item_customers_cart_path(product_id: product.id), method: :delete, class: "btn btn-sm btn-danger" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>

        <% tax_rate = 0.11 %>
        <% tax_amount = total * tax_rate %>
        <% total_with_tax = total + tax_amount %>

        <div class="text-end mt-4">
          <p><strong>Store Subtotal:</strong> <%= number_to_currency(total) %></p>
          <p><strong>Taxes (11%):</strong> <%= number_to_currency(tax_amount) %></p>
          <h4><strong>Total for this store:</strong> <%= number_to_currency(total_with_tax) %></h4>
        </div>

        <div class="mt-3">
          <%= button_to "Checkout for this store", checkout_customers_cart_path(store_id: store.id), method: :post, class: "btn btn-success" %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="d-flex justify-content-between mt-3">
    <%= button_to "Clear Cart", clear_cart_customers_cart_path, method: :delete, class: "btn btn-outline-danger" %>
  </div>
<% else %>
  <div class="alert alert-info">
    Your cart is empty.
  </div>
<% end %>